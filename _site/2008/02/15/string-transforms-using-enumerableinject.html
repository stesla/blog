<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Alieniloquent: String transforms using <code>Enumerable#inject</code></title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-reset.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-fonts.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-grids.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/simple-style.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/blog.css" />
</head>
<body>
 <div id="doc" class="yui-t4">
   <div id="hd" class="content">
     <h1 id="title"><a href="http://www.alieniloquent.com/">Alieniloquent</a></h1>
     <ul id="navigation">
       <li class="first"><a href="http://blog.alieniloquent.com">blog</a></li>
       <li><a href="http://github.com/stesla">code</a></li>
       <li><a href="http://www.alieniloquent.com/resume.pdf">resum&eacute;</a></li>
     </ul>
     <br/>
   </div>
   <div id="bd">
     <div id="yui-main">
       <div class="yui-b">
         <div class="post">
  <h3><a href="/2008/02/15/string-transforms-using-enumerableinject.html" title="Permalink for this post">String transforms using <code>Enumerable#inject</code></a></h3>
  <p class="date">February 15th, 2008</p>
  <div class="entry"><p>I love functional programming, and I love <a href='http://www.ruby-lang.org'>Ruby</a>. One of the most awesome things about Ruby is how much it borrows from the functional programming mindset. One of the most powerful concepts that functional programming brings to the table is higher-order functions. Ruby&#8217;s <code>Enumerable</code> module is a great example of how it embraces the idea of higher-order functions to abstract out the various things you do with a collection and let you focus on the operation for each item.</p>

<p>One of the most mysterious methods on <code>Enumerable</code> is <code>Enumerable#inject</code>. The example that&#8217;s always given is this:</p>
<div class='highlight'><pre><code class='text'>irb&gt; [1, 2, 3, 4].inject(0) {|sum, i| sum + i}
10
</code></pre>
</div>
<p>That&#8217;s fine, and usually makes sense. But when you try to branch out into more esoteric uses of inject, it can get confusing. So I&#8217;m going to give an example of accomplishing something useful with inject that you hopefully find useful.</p>

<p>I always find myself doing a sequence of substitutions on a string. For example, when I implement a <a href='http://tools.ietf.org/html/rfc854'>Telnet</a> client, I like to normalize the line endings I&#8217;m sending so that they&#8217;re sane. I accomplish that by translating &#8220;\r\n&#8221; to &#8220;\n&#8221;, then translating &#8220;\r&#8221; to &#8220;\n&#8221;, then translating &#8220;\n&#8221; to &#8220;\r\n&#8221;. It&#8217;s a simple thing to do, and I could do it like this:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>string</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>)</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\r</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>)</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>But that&#8217;s not very extensible. I&#8217;d like to apply this idea of a sequence of substitutions in an abstract way so that I can do dynamically. And while I could do something with <code>Object#send</code>, that&#8217;s like cheating. This is where inject comes to the rescue.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>normalize_line_endings</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span>
  <span class='n'>transforms</span> <span class='o'>=</span> <span class='o'>[</span><span class='nb'>proc</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='o'>|</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>)},</span>
                <span class='nb'>proc</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='o'>|</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\r</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>)},</span>
                <span class='nb'>proc</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='o'>|</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>)}</span><span class='o'>]</span>
  <span class='n'>transforms</span><span class='o'>.</span><span class='n'>inject</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>transform</span><span class='o'>|</span> <span class='n'>transform</span><span class='o'>.</span><span class='n'>call</span><span class='p'>(</span><span class='n'>s</span><span class='p'>)}</span>
<span class='k'>end</span>
</code></pre>
</div>
<p><code>Kernel#proc</code> (or <code>Kernel#lambda</code> if you prefer) is Ruby&#8217;s way of making higher-order functions. It returns a block which you can then call with an argument. In the above code, I make an array of transforms that take a string and return a string. The call to inject at the end is where the magic happens. It calls the first transform with <code>string</code> which was provided as the argument to inject. Then it calls the second transform with the result of the first, and it calls the third transform with the result of the second. That list could be as big as you want. It could even be dynamically generated.</p>

<p>That&#8217;s nice, but it&#8217;s still a a little verbose. I like to hide my use of <code>Kernel#proc</code> behind a declarative interface when I&#8217;m doing this sort of thing with it. So here&#8217;s how we can rewrite the method.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>transform</span><span class='p'>(</span><span class='n'>string</span><span class='p'>,</span> <span class='n'>specifications</span> <span class='o'>=</span> <span class='o'>[]</span><span class='p'>)</span>
  <span class='n'>transforms</span> <span class='o'>=</span> <span class='n'>specifications</span><span class='o'>.</span><span class='n'>collect</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>spec</span><span class='o'>|</span>
                 <span class='nb'>proc</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='o'>|</span> <span class='n'>s</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='n'>spec</span><span class='o'>[</span><span class='ss'>:from</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>spec</span><span class='o'>[</span><span class='ss'>:to</span><span class='o'>]</span><span class='p'>)}</span>
               <span class='k'>end</span>
  <span class='n'>transforms</span><span class='o'>.</span><span class='n'>inject</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span> <span class='p'>{</span><span class='o'>|</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>transform</span><span class='o'>|</span> <span class='n'>transform</span><span class='o'>.</span><span class='n'>call</span><span class='p'>(</span><span class='n'>s</span><span class='p'>)}</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>normalize_line_endings</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span>
  <span class='n'>transform</span><span class='p'>(</span><span class='n'>string</span><span class='p'>,</span> <span class='o'>[</span><span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>},</span>
                     <span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>},</span>
                     <span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>}</span><span class='o'>]</span><span class='p'>)</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Of course, at that point, we don&#8217;t really need to create the procs. We can just use inject right on the specifications array, so the final code I came up with for this was:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>def</span> <span class='nf'>transform</span><span class='p'>(</span><span class='n'>string</span><span class='p'>,</span> <span class='n'>specifications</span> <span class='o'>=</span> <span class='o'>[]</span><span class='p'>)</span>
  <span class='n'>specifications</span><span class='o'>.</span><span class='n'>inject</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>s</span><span class='p'>,</span> <span class='n'>spec</span><span class='o'>|</span>
    <span class='n'>s</span><span class='o'>.</span><span class='n'>gsub</span><span class='p'>(</span><span class='n'>spec</span><span class='o'>[</span><span class='ss'>:from</span><span class='o'>]</span><span class='p'>,</span> <span class='n'>spec</span><span class='o'>[</span><span class='ss'>:to</span><span class='o'>]</span><span class='p'>)</span>
  <span class='k'>end</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>normalize_line_endings</span><span class='p'>(</span><span class='n'>string</span><span class='p'>)</span>
  <span class='n'>transform</span><span class='p'>(</span><span class='n'>string</span><span class='p'>,</span> <span class='o'>[</span><span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>},</span>
                     <span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>},</span>
                     <span class='p'>{</span><span class='ss'>:from</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\n</span><span class='s2'>&quot;</span><span class='p'>,</span> <span class='ss'>:to</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;</span><span class='se'>\r\n</span><span class='s2'>&quot;</span><span class='p'>}</span><span class='o'>]</span><span class='p'>)</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Now that can be used with any list of transformations. Those transformations can be dynamically generated, and it&#8217;s a very clean implementation. That is the power of <code>Enumerable#inject</code>.</p></div>
  <p class="metadata alt">You may notice that I do not provide a space
    for comments. If you want to start a conversation, you can
    <a href="mailto:blog@alieniloquent.com">email me</a>, 
    <a href="http://twitter.com/stesla">tweet at me</a>, or post
    something on your own blog.</p>
</div>

       </div>
     </div>
     <div class="yui-b">
       <div class="yui-u sidebar">
         <h2 class="sectionheader first">Archives</h2>
         <ul>
           
           <li><a href="/2011/">2011</a></li>
           
           <li><a href="/2010/">2010</a></li>
           
           <li><a href="/2009/">2009</a></li>
           
           <li><a href="/2008/">2008</a></li>
           
           <li><a href="/2007/">2007</a></li>
           
           <li><a href="/2006/">2006</a></li>
           
           <li><a href="/2005/">2005</a></li>
           
         </ul>
       </div>
     </div>
   </div>
   <div id="ft">
     <p>Layout, design, graphics, photography and text all &copy; 2005-2010 Samuel Tesla unless otherwise noted.</p>
     <p>Portions of the site layout use Yahoo! YUI Reset, Fonts &amp; Grids.</p>
   </div>
 </div>

<!-- BEGIN GOOGLE ANALYTICS -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-12538528-2");
pageTracker._setDomainName(".alieniloquent.com");
pageTracker._trackPageview();
} catch(err) {}</script>
<!-- END GOOGLE ANALYTICS -->

</body>
</html>

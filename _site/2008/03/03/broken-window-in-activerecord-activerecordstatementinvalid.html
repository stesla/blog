<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Alieniloquent: Broken Window in ActiveRecord: <code>ActiveRecord::StatementInvalid</code></title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-reset.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-fonts.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-grids.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/simple-style.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/blog.css"/>
  <link href="http://blog.alieniloquent.com/feed" rel="alternate" title="main feed" type="application/rss+xml"/>
</head>
<body>
 <div id="doc" class="yui-t4">
   <div id="hd" class="content">
     <h1 id="title"><a href="http://www.alieniloquent.com/">Alieniloquent</a></h1>
     <ul id="navigation">
       <li class="first"><a href="http://blog.alieniloquent.com">blog</a></li>
       <li><a href="http://github.com/stesla">code</a></li>
       <li><a href="http://www.alieniloquent.com/resume.pdf">resum&eacute;</a></li>
     </ul>
     <br/>
   </div>
   <div id="bd">
     <div id="yui-main">
       <div class="yui-b">
         <div class="post">
  <h3><a href="/2008/03/03/broken-window-in-activerecord-activerecordstatementinvalid.html" title="Permalink for this post">Broken Window in ActiveRecord: <code>ActiveRecord::StatementInvalid</code></a></h3>
  <p class="date">March 3rd, 2008</p>
  <div class="entry"><p>I love ruby, and I love Rails, but in some ways it really is a ghetto. It has a lot of <a href='http://en.wikipedia.org/wiki/Fixing_Broken_Windows'>broken windows</a> that only serve to encourage bad coding from developers who should know better. Today I ran into an example of one of those broken windows and I was beside myself. I could not believe what I was reading.</p>

<p>One of the projects I work on for my employer is an import process that takes a long time. In order to make it resilient to database fail-overs, I wanted to catch the exception that is raised when the connection dies, wait a few seconds, and then try to reconnect. The idea is simple, and it works once I account for the broken window, but I am not pleased with the code I had to write.</p>

<p>When the database connection disappears, the database driver throws an exception. <code>ActiveRecord::Base</code> catches that exception and does this:</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># Find this in Rails 2.0.2</span>
<span class='c1'># active_record/connection_adapter/abstract_adapter.rb:121</span>

<span class='k'>rescue</span> <span class='no'>Exception</span> <span class='o'>=&gt;</span> <span class='n'>e</span>
  <span class='c1'># Log message and raise exception.</span>
  <span class='c1'># Set last_verfication to 0, so that connection gets verified</span>
  <span class='c1'># upon reentering the request loop</span>
  <span class='vi'>@last_verification</span> <span class='o'>=</span> <span class='mi'>0</span>
  <span class='n'>message</span> <span class='o'>=</span> <span class='s2'>&quot;</span><span class='si'>#{</span><span class='n'>e</span><span class='o'>.</span><span class='n'>class</span><span class='o'>.</span><span class='n'>name</span><span class='si'>}</span><span class='s2'>: </span><span class='si'>#{</span><span class='n'>e</span><span class='o'>.</span><span class='n'>message</span><span class='si'>}</span><span class='s2'>: </span><span class='si'>#{</span><span class='n'>sql</span><span class='si'>}</span><span class='s2'>&quot;</span>
  <span class='n'>log_info</span><span class='p'>(</span><span class='n'>message</span><span class='p'>,</span> <span class='nb'>name</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>
  <span class='k'>raise</span> <span class='no'>ActiveRecord</span><span class='o'>::</span><span class='no'>StatementInvalid</span><span class='p'>,</span> <span class='n'>message</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>This is the exception handler that catches all exceptions raised during a query run by ActiveRecord. As you can see, it snags the class name, and the exception message off of the exception, and then throws the object away, reraising with <code>ActiveRecord::StatementInvalid</code>. So, if your database driver has hundreds of error codes which are provided in order for you to tell specifically what error occurred, such as <code>Mysql::Error</code>, you lost them.</p>

<p>So ActiveRecord provides <em>one</em> exception that covers everything from primary key violations to database connection errors, and the only way to distinguish them is by inspecting the message. Surely, that can&#8217;t be true, right? I dig further and find this:</p>
<div class='highlight'><pre><code class='text'># Find this in Rails 2.0.2
# active_record/connection_adapters/mysql_adapter.rb:244
#
# Note: I snipped the error message because it is very long

rescue ActiveRecord::StatementInvalid =&gt; exception
  if exception.message.split(&quot;:&quot;).first =~ /Packets out of order/
    raise ActiveRecord::StatementInvalid, snipped_error_message
  else
    raise
  end
end
</code></pre>
</div>
<p>That is just completely unacceptable. I can find it in my heart to forgive the abstract adapter for doing something that throws away implementation-specific information, but the Mysql adapter should remedy that. It willingly lets it&#8217;s exception information be cast aside and goes about inspecting what the abstract adapter had the decency to keep around.</p>

<p>&#8220;But that information is good enough to tell what the exception is,&#8221; you might say.</p>

<p>Until the Mysql folks change the error message. The Mysql API exposes numeric constants, and I&#8217;m sure they&#8217;re very careful to keep them the same, but do you think they take the same approach to error messages? I doubt it. They provide a function that will give you an error message given the numeric constant, and encourage you to use it. That&#8217;s what the Mysql bindings for ruby do.</p>

<p>Expecting developers to inspect the exception message is essentially promoting programming with magic numbers. Sure, they&#8217;re string literals, but they&#8217;re still duplicated information, and extremely brittle.</p>

<p>All I&#8217;d want is an <code>inner_exception</code> attribute available on <code>ActiveRecord::StatementInvalid</code> or maybe its parent, and then assign it when doing reraises. Is that too much to ask for?</p></div>
  <p class="metadata alt">You may notice that I do not provide a space
    for comments. If you want to start a conversation, you can
    <a href="mailto:blog@alieniloquent.com">email me</a>, 
    <a href="http://twitter.com/stesla">tweet at me</a>, or post
    something on your own blog.</p>
</div>

       </div>
     </div>
     <div class="yui-b">
       <div class="yui-u sidebar">
         <h2 class="sectionheader first">Archives</h2>
         <ul>
           
           <li><a href="/2011/">2011</a></li>
           
           <li><a href="/2010/">2010</a></li>
           
           <li><a href="/2009/">2009</a></li>
           
           <li><a href="/2008/">2008</a></li>
           
           <li><a href="/2007/">2007</a></li>
           
           <li><a href="/2006/">2006</a></li>
           
           <li><a href="/2005/">2005</a></li>
           
         </ul>
       </div>
     </div>
   </div>
   <div id="ft">
     <p>Layout, design, graphics, photography and text all &copy; 2005-2010 Samuel Tesla unless otherwise noted.</p>
     <p>Portions of the site layout use Yahoo! YUI Reset, Fonts &amp; Grids.</p>
   </div>
 </div>

<!-- BEGIN GOOGLE ANALYTICS -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-12538528-2");
pageTracker._setDomainName(".alieniloquent.com");
pageTracker._trackPageview();
} catch(err) {}</script>
<!-- END GOOGLE ANALYTICS -->

</body>
</html>

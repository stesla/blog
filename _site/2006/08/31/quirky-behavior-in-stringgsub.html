<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Alieniloquent: Quirky Behavior in <code>String#gsub</code></title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-reset.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-fonts.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-grids.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/simple-style.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/blog.css" />
</head>
<body>
 <div id="doc" class="yui-t4">
   <div id="hd" class="content">
     <h1 id="title"><a href="http://www.alieniloquent.com/">Alieniloquent</a></h1>
     <ul id="navigation">
       <li class="first"><a href="http://blog.alieniloquent.com">blog</a></li>
       <li><a href="http://github.com/stesla">code</a></li>
       <li><a href="http://www.alieniloquent.com/resume.pdf">resum&eacute;</a></li>
     </ul>
     <br/>
   </div>
   <div id="bd">
     <div id="yui-main">
       <div class="yui-b">
         <div class="post">
  <h3><a href="/2006/08/31/quirky-behavior-in-stringgsub.html" title="Permalink for this post">Quirky Behavior in <code>String#gsub</code></a></h3>
  <p class="date">August 31st, 2006</p>
  <div class="entry"><p>At my office I develop in Delphi. We use Delphi 2006. As far as IDEs go, it&#8217;s not that great. For example, when you tell the Delphi 2006 IDE to do a build all (something you&#8217;d think developers do quite frequently), it has a very annoying behavior: it eats up scads of memory. In fact when the build all operation completes on our project group, Delphi has laid claim to over 1GB of memory, and it won&#8217;t let it go until you quit the application. But, this post isn&#8217;t about Delphi or its buggy IDE. It&#8217;s about ruby. More specifically, it&#8217;s about a quirk (read: bug) in ruby.</p>

<p>The <a href='http://ruby-doc.org/core/classes/String.html'><code>String</code></a> class in ruby has a method called <code>gsub</code>. This method takes two parameters and each can take two types of object. The first parameter can either be a Regexp or a String, and it represents what is to be replaced. The second can either be a String or a block, and supplies the value with which to replace it. This seems perfectly natural.</p>

<p>Now, if you&#8217;ve ever used regular expressions, you probably know about back- references. When you use the grouping operator in a regular expression (e.g. <code>^a(ab)b$</code>) it stores a numbered back-reference to the matched value of each group. In ruby you can reference these with the special variables <code>$1</code>, <code>$2</code>, and so on. But, if you are passing a string as the replacement, it will only be interpolated once and those back-references won&#8217;t be correct. So, what <code>gsub</code> does is let you put in <code>\1</code> and <code>\2</code> instead.</p>

<p>That behavior is awesome, and exactly what you want, if you&#8217;re matching a regular expression. But if you&#8217;re just matching a string literal, there is absolutely no reason to do it. In fact, if all you&#8217;re doing is matching a string literal those back-references will all be the empty string.</p>

<p>So, how do I know all this? Well, because Delphi 2006&#8217;s build all operation bites, we wrote a ruby script to replace it. This script has to do file-name manipulation and all sorts of other string manipulation in order to get all of the correct compiler options. One of the things it does is replace strings like <code>$(CodeBase)</code> with a path such as <code>c:\svn\trunk</code>. Well, we have separate code bases for our branches, and they have names like <code>c:\svn\2006</code>. You see that <code>\2</code> there? Yeah, that one, right in the middle of the path. Even though the script was matching a string literal, <code>gsub</code> was replacing back- references. Since the path happened to have a <code>\2</code> in it, it would end up coming out of gsub as <code>c:\svn006</code>, and that certainly wasn&#8217;t right.</p>

<p>Thankfully, there is a simple work around. Instead of providing a string for the replacement, we can provide a block. That block gets called every time and the value that it returns is <em>exactly</em> what gets used as the replacement.</p></div>
  <p class="metadata alt">You may notice that I do not provide a space
    for comments. If you want to start a conversation, you can
    <a href="mailto:blog@alieniloquent.com">email me</a>, 
    <a href="http://twitter.com/stesla">tweet at me</a>, or post
    something on your own blog.</p>
</div>

       </div>
     </div>
     <div class="yui-b">
       <div class="yui-u sidebar">
         <h2 class="sectionheader first">Archives</h2>
         <ul>
           
           <li><a href="/2011/">2011</a></li>
           
           <li><a href="/2010/">2010</a></li>
           
           <li><a href="/2009/">2009</a></li>
           
           <li><a href="/2008/">2008</a></li>
           
           <li><a href="/2007/">2007</a></li>
           
           <li><a href="/2006/">2006</a></li>
           
           <li><a href="/2005/">2005</a></li>
           
         </ul>
       </div>
     </div>
   </div>
   <div id="ft">
     <p>Layout, design, graphics, photography and text all &copy; 2005-2010 Samuel Tesla unless otherwise noted.</p>
     <p>Portions of the site layout use Yahoo! YUI Reset, Fonts &amp; Grids.</p>
   </div>
 </div>

<!-- BEGIN GOOGLE ANALYTICS -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-12538528-2");
pageTracker._setDomainName(".alieniloquent.com");
pageTracker._trackPageview();
} catch(err) {}</script>
<!-- END GOOGLE ANALYTICS -->

</body>
</html>

<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Alieniloquent: Calling into the C++ DLL from Delphi</title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-reset.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-fonts.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/yui-grids.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/simple-style.css"/>
  <link rel="stylesheet" type="text/css" href="/stylesheets/blog.css" />
</head>
<body>
 <div id="doc" class="yui-t4">
   <div id="hd" class="content">
     <h1 id="title"><a href="http://www.alieniloquent.com/">Alieniloquent</a></h1>
     <ul id="navigation">
       <li class="first"><a href="http://blog.alieniloquent.com">blog</a></li>
       <li><a href="http://github.com/stesla">code</a></li>
       <li><a href="http://www.alieniloquent.com/resume.pdf">resum&eacute;</a></li>
     </ul>
     <br/>
   </div>
   <div id="bd">
     <div id="yui-main">
       <div class="yui-b">
         <div class="post">
  <h3><a href="/2007/01/01/calling-into-the-c-dll-from-delphi.html" title="Permalink for this post">Calling into the C++ DLL from Delphi</a></h3>
  <p class="date">January 1st, 2007</p>
  <div class="entry"><p>Before I get to the meat of this post, I want to make some ammendments and edits to the code from the last one. Today I was wrangling around and began to recall more of my C++, initializers in particular, so I&#8217;ve updated the <code>Example1</code> class to use them.</p>
<div class='highlight'><pre><code class='c'><span class='n'>public</span> <span class='n'>class</span> <span class='n'>Example1</span>
<span class='p'>{</span>
 <span class='nl'>public:</span>

  <span class='n'>Example1</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span> <span class='o'>*</span> <span class='n'>name</span><span class='p'>)</span> <span class='o'>:</span> <span class='n'>_name</span><span class='p'>(</span><span class='n'>gcnew</span> <span class='n'>String</span><span class='p'>(</span><span class='n'>name</span><span class='p'>))</span> <span class='p'>{}</span>
  <span class='o'>~</span><span class='n'>Example1</span><span class='p'>()</span> <span class='p'>{}</span>
  <span class='kt'>void</span> <span class='n'>ShowName</span><span class='p'>();</span>

 <span class='nl'>private:</span>

  <span class='n'>gcroot</span><span class='o'>&lt;</span><span class='n'>String</span> <span class='o'>^&gt;</span> <span class='n'>_name</span><span class='p'>;</span>
<span class='p'>};</span>
</code></pre>
</div>
<p>I also realize that I forgot to show the implementation side of that class, so here it is:</p>
<div class='highlight'><pre><code class='c'><span class='cp'>// Example.cpp</span>
<span class='cp'>#include &quot;stdafx.h&quot;</span>
<span class='cp'>#include &quot;Example.h&quot;</span>

<span class='n'>using</span> <span class='n'>namespace</span> <span class='n'>System</span><span class='o'>::</span><span class='n'>Windows</span><span class='o'>::</span><span class='n'>Forms</span><span class='p'>;</span>

<span class='kt'>void</span> <span class='n'>Example</span><span class='o'>::</span><span class='n'>Example1</span><span class='o'>::</span><span class='n'>ShowName</span><span class='p'>()</span>
<span class='p'>{</span>
  <span class='n'>MessageBox</span><span class='o'>::</span><span class='n'>Show</span><span class='p'>(</span><span class='n'>_name</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>So there&#8217;s our DLL. Now, let&#8217;s use it from Delphi! I&#8217;m using Turbo Delphi for Win32 to do this. Go to File &gt; New &gt; &#8220;VCL Forms Application&#8221; and make your project. Make sure that it outputs to the same directory that the DLL does (or make the DLL output to the same directory this project does, which is what I do) for ease of edit-compile-run cycling.</p>

<p>I&#8217;m going to drop a <code>TEdit</code> and a <code>TButton</code> on the main form and hook it up so that when we click the button it creates an <code>Example1</code>, shows it, and then deletes it. Here is the implementation section from the main unit in the delphi program:</p>
<div class='highlight'><pre><code class='delphi'><span class='k'>function</span> <span class='nf'>Example1Create</span><span class='p'>(</span><span class='n'>AName</span><span class='o'>:</span> <span class='kt'>PChar</span><span class='p'>)</span><span class='o'>:</span> <span class='kt'>Pointer</span><span class='o'>;</span>
<span class='kp'>cdecl</span><span class='o'>;</span> <span class='kp'>external</span> <span class='s'>&#39;Example&#39;</span><span class='o'>;</span>

<span class='k'>procedure</span> <span class='nf'>Example1Delete</span><span class='p'>(</span><span class='n'>AExample</span><span class='o'>:</span> <span class='kt'>Pointer</span><span class='p'>)</span><span class='o'>;</span>
<span class='kp'>cdecl</span><span class='o'>;</span> <span class='kp'>external</span> <span class='s'>&#39;Example&#39;</span><span class='o'>;</span>

<span class='k'>procedure</span> <span class='nf'>Example1ShowName</span><span class='p'>(</span><span class='n'>AExample</span><span class='o'>:</span> <span class='kt'>Pointer</span><span class='p'>)</span><span class='o'>;</span>
<span class='kp'>cdecl</span><span class='o'>;</span> <span class='kp'>external</span> <span class='s'>&#39;Example&#39;</span><span class='o'>;</span>

<span class='k'>procedure</span> <span class='nc'>TForm1</span><span class='o'>.</span><span class='nf'>btnDoItClick</span><span class='p'>(</span><span class='n'>Sender</span><span class='o'>:</span> <span class='kt'>TObject</span><span class='p'>)</span><span class='o'>;</span>
<span class='k'>var</span>
  <span class='n'>Example</span><span class='o'>:</span> <span class='kt'>Pointer</span><span class='o'>;</span>
<span class='k'>begin</span>
  <span class='n'>Example</span> <span class='o'>:=</span> <span class='n'>Example1Create</span><span class='p'>(</span><span class='kt'>PChar</span><span class='p'>(</span><span class='n'>edtName</span><span class='o'>.</span><span class='n'>Text</span><span class='p'>))</span><span class='o'>;</span>
  <span class='k'>try</span>
     <span class='n'>Example1ShowName</span><span class='p'>(</span><span class='n'>Example</span><span class='p'>)</span><span class='o'>;</span>
  <span class='k'>finally</span>
     <span class='n'>Example1Delete</span><span class='p'>(</span><span class='n'>Example</span><span class='p'>)</span><span class='o'>;</span>
  <span class='k'>end</span><span class='o'>;</span>
<span class='k'>end</span><span class='o'>;</span>
</code></pre>
</div>
<p>The button handler is straight-forward and normal. The only interesting thing there is to see how the calls from the DLL get used. The lifetime management works just like anything else, you just aren&#8217;t going to use <code>FreeAndNil</code> like you would for most things.</p>

<p>The interesting part is at the top where we import from the DLL, let&#8217;s look at one of those lines again:</p>
<div class='highlight'><pre><code class='delphi'><span class='k'>function</span> <span class='nf'>Example1Create</span><span class='p'>(</span><span class='n'>AName</span><span class='o'>:</span> <span class='kt'>PChar</span><span class='p'>)</span><span class='o'>:</span> <span class='kt'>Pointer</span><span class='o'>;</span>
<span class='kp'>cdecl</span><span class='o'>;</span> <span class='kp'>external</span> <span class='s'>&#39;Example&#39;</span><span class='o'>;</span>
</code></pre>
</div>
<p>Now this corresponds to the following line from <code>Exports.h</code>:</p>
<div class='highlight'><pre><code class='c'><span class='n'>DLLAPI</span> <span class='kt'>void</span> <span class='o'>*</span> <span class='n'>Example1Create</span><span class='p'>(</span><span class='k'>const</span> <span class='kt'>char</span> <span class='o'>*</span> <span class='n'>name</span><span class='p'>);</span>
</code></pre>
</div>
<p>Since it has a return type that is not void, it becomes a function (the others became procedures). The <code>void *</code> becomes <code>Pointer</code>, and the <code>const char *
name</code> becomes <code>PChar</code> in Delphi. So what&#8217;s the rest of that garbage? The <code>cdecl</code> flag is there to tell the compiler what calling convention to use. If you just create the DLL in Visual Studio, it defaults to using <code>cdecl</code>. You can also use something like <code>stdcall</code>, but it&#8217;s not necessary here. The other part just tells Delphi which DLL to look for this external function in.</p>

<p>So now we know how to call code from the DLL. Next time I&#8217;ll show you how to pass procedure pointers and even method pointers from Delphi into the DLL and have them get called properly for things like progress bars.</p></div>
  <p class="metadata alt">You may notice that I do not provide a space
    for comments. If you want to start a conversation, you can
    <a href="mailto:blog@alieniloquent.com">email me</a>, 
    <a href="http://twitter.com/stesla">tweet at me</a>, or post
    something on your own blog.</p>
</div>

       </div>
     </div>
     <div class="yui-b">
       <div class="yui-u sidebar">
         <h2 class="sectionheader first">Archives</h2>
         <ul>
           
           <li><a href="/2011/">2011</a></li>
           
           <li><a href="/2010/">2010</a></li>
           
           <li><a href="/2009/">2009</a></li>
           
           <li><a href="/2008/">2008</a></li>
           
           <li><a href="/2007/">2007</a></li>
           
           <li><a href="/2006/">2006</a></li>
           
           <li><a href="/2005/">2005</a></li>
           
         </ul>
       </div>
     </div>
   </div>
   <div id="ft">
     <p>Layout, design, graphics, photography and text all &copy; 2005-2010 Samuel Tesla unless otherwise noted.</p>
     <p>Portions of the site layout use Yahoo! YUI Reset, Fonts &amp; Grids.</p>
   </div>
 </div>

<!-- BEGIN GOOGLE ANALYTICS -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-12538528-2");
pageTracker._setDomainName(".alieniloquent.com");
pageTracker._trackPageview();
} catch(err) {}</script>
<!-- END GOOGLE ANALYTICS -->

</body>
</html>
